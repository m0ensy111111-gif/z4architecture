import streamlit as st
import numpy as np

# --- é¡µé¢é…ç½® ---
st.set_page_config(page_title="ç©¿å­”é“æ¿åŠå¾„é¢„æµ‹æ¨¡å‹", layout="wide")

st.title("ğŸ—ï¸ ç©¿å­”é“æ¿å‚æ•°åŒ–è®¾è®¡ä»£ç†æ¨¡å‹")
st.markdown("""
æœ¬å·¥å…·åŸºäº 1000 ç»„æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆçš„**å¯¹æ•°å›å½’æ–¹ç¨‹**ï¼Œå¯å®æ—¶é¢„æµ‹æ»¡è¶³å®¤å†…ç…§åº¦è¦æ±‚çš„ç©¿å­”é“æ¿åŠå¾„ã€‚
""")

# --- ä¾§è¾¹æ ï¼šå‚æ•°è¾“å…¥ ---
st.sidebar.header("è¾“å…¥è®¾è®¡å‚æ•°")

# æ—¶é—´å‚æ•°
month = st.sidebar.slider("æœˆä»½ (Month)", 1, 12, 6)
day = st.sidebar.slider("æ—¥æœŸ (Day)", 1, 30, 21)
hour = st.sidebar.slider("å°æ—¶ (Hour)", 8, 17, 12)

# å‡ ä½•å‚æ•°
azi = st.sidebar.number_input("å¤ªé˜³æ–¹ä½è§’ (Sun Azimuth)", 0.0, 359.0, 180.0)
ori = st.sidebar.number_input("å»ºç­‘æœå‘è§’ (Orientation)", 0.0, 359.0, 180.0)

# ç¯å¢ƒå‚æ•°
ein = st.sidebar.number_input("ç›®æ ‡å®¤å†…ç…§åº¦ (Inside Lux)", 0.0, 1000.0, 300.0)
eout = st.sidebar.number_input("å®¤å¤–ç¯å¢ƒç…§åº¦ (Outside Lux)", 0.0, 150000.0, 50000.0)

# --- æ ¸å¿ƒè®¡ç®—é€»è¾‘ ---
def predict_radius(m, d, h, azi, ori, ein, eout):
    # æ¨¡å‹ç³»æ•° (åŸºäºä¹‹å‰è®¡ç®—çš„ç²¾ç¡®å€¼)
    intercept = 91.6596
    c_m = -0.0002
    c_d = 0.0785
    c_h = 0.0810
    c_cos = 0.1089
    c_ein = 76.6408
    c_eout = -69.4599
    
    # å‡ ä½•å˜æ¢
    cos_diff = np.cos(np.radians(azi - ori))
    
    # å¯¹æ•°å˜æ¢
    log_ein = np.log1p(ein)
    log_eout = np.log1p(eout)
    
    # æ–¹ç¨‹æ±‚å’Œ
    r = (intercept + (c_m * m) + (c_d * d) + (c_h * h) + 
         (c_cos * cos_diff) + (c_ein * log_ein) + (c_eout * log_eout))
    
    # é™åˆ¶ç‰©ç†èŒƒå›´ (1-150mm)
    return max(1.0, min(150.0, r)), cos_diff

# æ‰§è¡Œé¢„æµ‹
predicted_r, cos_val = predict_radius(month, day, hour, azi, ori, ein, eout)

# --- ç»“æœå±•ç¤º ---
col1, col2 = st.columns(2)

with col1:
    st.metric(label="é¢„æµ‹å­”æ´åŠå¾„ (R)", value=f"{predicted_r:.2f} mm")
    st.info(f"å½“å‰å…¥å°„å› å­ cos(diff): {cos_val:.4f}")

with col2:
    st.subheader("æœ€ç»ˆæ•°å­¦æ–¹ç¨‹")
    st.latex(r"R = 91.66 - 0.0002M + 0.078D + 0.081H + 0.11\cos(Azi-Ori) + 76.64\ln(E_{in}+1) - 69.46\ln(E_{out}+1)")

# --- åº•éƒ¨å›¾è¡¨æˆ–è¯´æ˜ ---
st.divider()
st.caption("æ³¨ï¼šæœ¬æ¨¡å‹æ‹Ÿåˆä¼˜åº¦ RÂ² â‰ˆ 0.91ã€‚å½“è®¡ç®—å€¼è¶…å‡º 1-150mm èŒƒå›´æ—¶ï¼Œä¼šè‡ªåŠ¨é”å®šåœ¨è¾¹ç•Œå€¼ã€‚")
